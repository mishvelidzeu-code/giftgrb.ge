<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>გერბის და გვარის დეტალები</title>
    <style>
        :root{ --bg:#f6f6f4; --white:#ffffff; --text:#1f2933; --gold:#c8a951; }
        body{ margin:0; background:var(--bg); font-family:Georgia, serif; color:var(--text); padding: 20px; }
        .status { text-align:center; margin-top:100px; font-size:18px; color: #666; }
        .container { max-width:900px; margin:40px auto; background:var(--white); border-radius:22px; padding:50px; box-shadow:0 30px 60px rgba(0,0,0,.08); display:none; }
        .cert-header { text-align:center; margin-bottom:40px; border-bottom: 2px solid #f3efe4; padding-bottom: 20px; }
        .cert-body { display:grid; grid-template-columns: 1fr 1fr; gap:40px; align-items: start; }
        .cert-body img { width:100%; border-radius:16px; border:1px solid #eee; }
        .cert-data p { margin:0 0 15px; border-bottom: 1px solid #f9f9f9; padding-bottom: 5px; }
        .cert-data span { display:block; font-size:12px; color:#999; text-transform:uppercase; }
        .cert-data strong { font-size:18px; color:#222; }
        .history-box { margin-top:40px; padding-top:20px; border-top: 1px solid #eee; }
        .history-title { color:var(--gold); font-weight:bold; margin-bottom:15px; display:block; }
        .history-text { line-height:1.8; white-space:pre-line; color:#444; }
        @media (max-width:650px) { .cert-body { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="status" class="status">იტვირთება მონაცემები...</div>

<div class="container" id="mainContainer">
    <div class="cert-header">
        <h1 id="pageTitle">გერბის სერტიფიკატი</h1>
    </div>

    <div class="cert-body">
        <div id="imageWrapper">
            <img id="mainImage" src="" alt="გამოსახულება">
        </div>
        <div class="cert-data">
            <p><span>რეგისტრაციის კოდი</span> <strong id="dCode"></strong></p>
            <p><span>მფლობელი / გვარი</span> <strong id="dOwner"></strong></p>
            <p><span>თარიღი</span> <strong id="dDate"></strong></p>
            <p><span>აღწერა</span> <strong id="dDesc"></strong></p>
        </div>
    </div>

    <div id="historySection" class="history-box" style="display:none;">
        <span class="history-title">გვარის ისტორიული მიმოხილვა</span>
        <div id="dHistory" class="history-text"></div>
    </div>
</div>

<script>
async function loadRegistry() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code')?.toUpperCase();

    if (!code) {
        document.getElementById('status').innerText = "შეცდომა: კოდი არ არის მითითებული.";
        return;
    }

    try {
        // 1. ორივე JSON ფაილის ერთდროულად წამოღება
        const [regRes, surRes] = await Promise.all([
            fetch('registry.json'),
            fetch('surnames.json')
        ]);

        if (!regRes.ok) throw new Error("registry.json ვერ ჩაიტვირთა");
        
        const registry = await regRes.json();
        const surnames = surRes.ok ? await surRes.json() : [];

        // 2. ძებნა რეესტრში
        const crest = registry.find(item => item.code.toUpperCase() === code);
        // 3. ძებნა ისტორიებში (crestCode-ით დაკავშირება)
        const historyData = surnames.find(item => item.crestCode?.toUpperCase() === code);

        if (!crest && !historyData) {
            document.getElementById('status').innerText = "ჩანაწერი კოდით " + code + " ვერ მოიძებნა.";
            return;
        }

        // 4. მონაცემების ასახვა
        document.getElementById('status').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';

        // თუ გერბი გვაქვს რეესტრში
        if (crest) {
            document.getElementById('dCode').innerText = crest.code;
            document.getElementById('dOwner').innerText = crest.owner;
            document.getElementById('dDate').innerText = crest.date;
            document.getElementById('dDesc').innerText = crest.description;
            
            if (crest.image) {
                document.getElementById('mainImage').src = crest.image;
            } else {
                document.getElementById('imageWrapper').style.display = 'none';
            }
        }

        // თუ ისტორია გვაქვს surnames.json-ში
        if (historyData) {
            document.getElementById('historySection').style.display = 'block';
            document.getElementById('dHistory').innerText = historyData.history;
            
            // თუ რეესტრში არ იყო მფლობელი, ისტორიიდან ავიღოთ გვარი
            if (!crest) {
                document.getElementById('dOwner').innerText = historyData.surname;
                document.getElementById('dCode').innerText = historyData.crestCode;
                document.getElementById('pageTitle').innerText = "საგვარეულო ისტორია";
                if (historyData.image) document.getElementById('mainImage').src = historyData.image;
            }
        }

    } catch (err) {
        console.error(err);
        document.getElementById('status').innerText = "შეცდომა: მონაცემთა ბაზასთან კავშირი ვერ დამყარდა.";
    }
}

window.onload = loadRegistry;
</script>

</body>
</html>